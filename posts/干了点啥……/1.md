# 实习生与服务器斗智斗勇

- 发布日期：2024/06/20

<img alt="内容图片" src="https://raw.githubusercontent.com/YDDLJW/YDDLJW.github.io/main/static/post_pictures/0620Server.jpg" style="max-width:600px; width:auto; height:auto;"/>

在学校空度了几年感觉啥也没学会，暑假又被家里人催着在找实习，寻思着闲着也是闲着，想找个地方学点有用的东西，可算是托了点关系找到了一家能实习的地方。

于是若干天后，公司新来了一台服务器，师傅让我帮忙看看有没有系统，没有就装个Ubuntu20.04，再把分辨率改成1920*1080，听上去很简单的工作，也应该确实是个很简单的工作，但我没想到是我噩梦三天的开始。

### 通过命令行修改分辨率

服务器启动后确实出厂自带一个Ubuntu20.04系统，但是分辨率固定为1024*768，且甚至连设置中自带的缩放功能都无法使用。

一开始根据网上的教程输入了以下指令：

```shell

cvt 1920*1080 //输出1920*1080显示模式的模式行
//输出中包括: modeline "1920*1080_60.00" ......

xrandr --newmode "1920*1080_60.00" ...... //为xrandr添加一个新的显示模式

xrandr --addmode default "1920*1080_60.00" //为输出default添加该显示模式
//此时设置中的显示界面会添加该显示模式选项

xrandr --output default --mode "1920*1080_60.00" //为输出default使用该显示模式

```

### 通过添加脚本修改分辨率

代码输入后无果，这是Ubuntu20.04一般来说的通过代码修改分辨率的方法。询问ChatGPT后它给出了另一种通过添加执行脚本来修改分辨率的方法，需要编辑`/etc/X11/xorg.conf`文件，内容如下：


```plaintext
Section "Monitor"
    Identifier "Configured Monitor"
    Modeline "1920x1080_60.00" 173.00 1920 2048 2248 2576 1080 1083 1088 1120 -hsync +vsync
EndSection

Section "Screen"
    Identifier "Default Screen"
    Monitor "Configured Monitor"
    Device "Configured Video Device"
    DefaultDepth 24
    SubSection "Display"
        Depth 24
        Modes "1920x1080_60.00"
    EndSubSection
EndSection
```
这不仅没有作用，反而让系统无法启动了！系统会在启动时卡在文件自检的过程中停住不动。

没用过linux相关系统的我顿时懵了，只能不断地查询解决方法与询问GPT，最终解决方案是在启动Ubuntu系统时按下ESC进入Ubuntu GRUB，从系统的Recovery mode启动，进入系统后台，通过后台的shell输入以下代码删除了添加的脚本，但是后来我删除了整个文件夹才能恢复正常：

```shell

sudo rm -rf /etc/X11

```

删除后系统又可以正常启动了，于是认为是系统当前的驱动不支持该分辨率，需要查询服务器的官方文档以解决。

### 为服务器共享网络并根据文档安装IDriver驱动

查询文档后，我第一时间看到的是需要安装`IDriver`驱动，这是该服务器官方的驱动程序，需要通过虚拟机将驱动程序的光盘镜像连接到服务器中，再在服务器里将文件保存到正确的位置并运行。

最开始没有网络，由于系统出场缺少安装驱动所需要的包，又需要通过我的电脑将连接的WIFI网络分享到连接服务器的以太网接口。

开启分享功能后，电脑上的以太网接口的IPV4的需要设置为：

    IP地址： 192.168.137.1
    子网掩码： 255.255.255.0
    首选DNS服务器： 192.168.137.1

此时如果服务器侧的IP地址为自动获取的，那么一般会被获取为`192.168.137.X`，其中X为随机分配的一个地址。

在有网络之后，就可以安装所需要的包了，根据驱动文件中的README执行以下命令：

```shell

sudo apt-get install <package_name>

```

在安装完之后，根据README执行安装用的命令：

```shell

cd /root/driver  //切换到驱动目录

chmod +x install.sh //给脚本添加可执行权限

./install.sh //执行自动脚本

```

安装重启后，并没有发生明显的变化，并且更改分辨率功能同样不可用，我陷入了僵局。

### 操作图形驱动

搜索后认为仍然应该是驱动的问题，IDriver并不是图形驱动，所以与修改系统分辨率的功能无关，需要进一步具体到图形驱动相关的操作。我通过以下指令调查了当前使用的图形驱动：

```shell

sudo apt-get install inxi //安装inxi包

inxi -G //查询当前显示器信息

```
该命令用inxi包查询当前显示器信息，其中包含了使用的驱动为`fbdev`，查询后得知该驱动功能较差，仅为最基本的驱动，不支持高分辨率。而`vesa`驱动的效果更好，于是尝试切换为`vesa`驱动：

```shell

sudo apt-get install xserver-xorg-video-vesa

```

并且在脚本文件中输入以下内容：
```plaintext
Section "Device"
    Identifier "Configured Video Device"
    Driver "vesa"
EndSection

Section "Monitor"
    Identifier "Configured Monitor"
EndSection

Section "Screen"
    Identifier "Default Screen"
    Device "Configured Video Device"
    Monitor "Configured Monitor"
    DefaultDepth 24
    SubSection "Display"
        Depth 24
        Modes "1024x768"
    EndSubSection
EndSection
```

重启后又出现问题了，系统可以正常启动却黑屏，很明显是文件没有问题，但驱动出现问题了，于是再次通过inxi查询当前驱动，发现驱动一项为`none`且`Unloaded`一项为`vesa`

于是再次删除脚本文件以及其所在文件夹，重启，可这回出现问题了：因为我删除了整个文件夹，里面很可能有一些必要的文件，导致图形驱动会寻找在其它文件夹中的配置文件进行配置，于是每次启动都会先执行一个我不知道位置的配置文件，可是该配置文件同样有问题，系统无法正常加载图形界面。

所幸这时候我已经能通过SSH从我的电脑连接到服务器，我在服务器后台输入以下指令重启`GDM`后，还能回到系统的图形界面：

```shell

sudo systemctl restart gdm

```

但是这治标不治本，由于我无法找到系统使用的配置文件，导致我每次启动时都需要输入该行命令才能成功进入图形界面。

### 安装真正的显卡驱动

在折腾了两天后，师傅看不下去了。由于我没有找到官方文档中有关服务器显卡以及显卡驱动的信息，我一直没有考虑需要下载显卡驱动，而师傅明确地知道该型号服务器的显卡型号，并且帮我安装好了显卡驱动，即通过`SCP`的命令从我的电脑将显卡驱动的安装相关文件复制到服务器并执行。

显卡驱动安装好后，重启，系统仍然是且仅有1024*768分辨率，但是自带的缩放功能可以使用了，这进展让我以为根本问题解决了，后续只需要根据情况修改脚本就可以将需要的分辨率加到系统设置中。

可是在执行了上述执行过的诸多方法之后，仍然出现了和上述一样的系统无法进入等问题，于是我怀疑是我安装的IDriver驱动的版本不对——通过命令行查询后，我的Ubuntu系统的版本号是20.04.6，而安装的IDriver对应的版本号为20.04。我认为这可能是导致显卡驱动无法正常修改分辨率的罪魁祸首。

于是我又去官网下载了另一个版本的IDriver驱动并安装，这带来了更大的问题。该驱动实际上是系统内核驱动，而版本的错误又导致了该内核无法正常挂载文件系统，直接导致连系统都启动不了。

我再次通过Ubuntu GRUB进入后台，看到了多出来的系统内核，但这次我选择了原来的系统内核，可以正常启动。

搜索之后我修改了配置文件，企图在启动时忽略掉新增的内核，而默认选择原先的内核进行启动，这又导致了一个最终无解的问题——系统彻底启动不了了，连后台都进不去。

### 重装系统

最后我寄希望于重置系统，而重置系统的唯一方法就是重新安装一个新系统。

我通过电脑上的虚拟机为服务器加载了下载好的Ubuntu系统光盘的镜像文件，并进入系统的BIOS模式，选择`Boot From File`，进入光盘文件，选择其中的boot文件启动，进入了Ubuntu系统的安装程序。

<img alt="内容图片" src="https://raw.githubusercontent.com/YDDLJW/YDDLJW.github.io/main/static/post_pictures/0620ServerBIOS.png" style="max-width:600px; width:auto; height:auto;"/>

安装过程中，我选择了格式化原来的硬盘，并自动安装所需的驱动。安装完成后，系统成功启动进入图形界面，我松了口气，因为这是我人生中第一次安装系统，还是为服务器安装。

安装好后，我先为其联网并运行以下指令尝试更新系统内现有的包：

```shell

sudo apt update

sudo apt upgrade

```

但是因为有三百多个包需要更新，这对我来说实在是太慢了，所以我在更新到大约20％的时候`^C`暂停了更新，并放弃安装IDriver，直接尝试安装显卡驱动。

可是安装显卡驱动时，出现了一件有趣的事——像之前一样复制文件到服务器并启动自动安装脚本后，直接提示`驱动已经被安装，请重启`，而没有提示任何安装过程，这让我不禁怀疑系统在安装时已经为我安装好了显卡驱动，或者说我刚刚在联网更新时系统帮我自动安装好了。

于是我半信半疑地重启，惊奇地发现系统已经自动被默认设置为了1920*1080分辨率，且设置中也默认显示出了其它各种参数的分辨率，连脚本都不需要我添加。

至此，这个检查新服务器系统并修改分辨率的基础工作终于结束了，耗费了我整整三天的时间。

唉，真正准备进入社会后才发现，无时无刻不感叹自己的无知，还是先好好学吧。